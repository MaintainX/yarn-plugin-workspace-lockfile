/* eslint-disable */
//prettier-ignore
module.exports = {
name: "@yarnpkg/plugin-workspace-lockfile",
factory: function (require) {
"use strict";var plugin=(()=>{var K=Object.create;var v=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var Y=Object.getOwnPropertyNames;var q=Object.getPrototypeOf,z=Object.prototype.hasOwnProperty;var h=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(n,r)=>(typeof require<"u"?require:n)[r]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var B=(e,n)=>()=>(n||e((n={exports:{}}).exports,n),n.exports),x=(e,n)=>{for(var r in n)v(e,r,{get:n[r],enumerable:!0})},M=(e,n,r,i)=>{if(n&&typeof n=="object"||typeof n=="function")for(let d of Y(n))!z.call(e,d)&&d!==r&&v(e,d,{get:()=>n[d],enumerable:!(i=Q(n,d))||i.enumerable});return e};var X=(e,n,r)=>(r=e!=null?K(q(e)):{},M(n||!e||!e.__esModule?v(r,"default",{value:e,enumerable:!0}):r,e)),J=e=>M(v({},"__esModule",{value:!0}),e);var W=B((ie,Z)=>{Z.exports=[{name:"Agola CI",constant:"AGOLA",env:"AGOLA_GIT_REF",pr:"AGOLA_PULL_REQUEST_ID"},{name:"Appcircle",constant:"APPCIRCLE",env:"AC_APPCIRCLE",pr:{env:"AC_GIT_PR",ne:"false"}},{name:"AppVeyor",constant:"APPVEYOR",env:"APPVEYOR",pr:"APPVEYOR_PULL_REQUEST_NUMBER"},{name:"AWS CodeBuild",constant:"CODEBUILD",env:"CODEBUILD_BUILD_ARN",pr:{env:"CODEBUILD_WEBHOOK_EVENT",any:["PULL_REQUEST_CREATED","PULL_REQUEST_UPDATED","PULL_REQUEST_REOPENED"]}},{name:"Azure Pipelines",constant:"AZURE_PIPELINES",env:"TF_BUILD",pr:{BUILD_REASON:"PullRequest"}},{name:"Bamboo",constant:"BAMBOO",env:"bamboo_planKey"},{name:"Bitbucket Pipelines",constant:"BITBUCKET",env:"BITBUCKET_COMMIT",pr:"BITBUCKET_PR_ID"},{name:"Bitrise",constant:"BITRISE",env:"BITRISE_IO",pr:"BITRISE_PULL_REQUEST"},{name:"Buddy",constant:"BUDDY",env:"BUDDY_WORKSPACE_ID",pr:"BUDDY_EXECUTION_PULL_REQUEST_ID"},{name:"Buildkite",constant:"BUILDKITE",env:"BUILDKITE",pr:{env:"BUILDKITE_PULL_REQUEST",ne:"false"}},{name:"CircleCI",constant:"CIRCLE",env:"CIRCLECI",pr:"CIRCLE_PULL_REQUEST"},{name:"Cirrus CI",constant:"CIRRUS",env:"CIRRUS_CI",pr:"CIRRUS_PR"},{name:"Cloudflare Pages",constant:"CLOUDFLARE_PAGES",env:"CF_PAGES"},{name:"Codefresh",constant:"CODEFRESH",env:"CF_BUILD_ID",pr:{any:["CF_PULL_REQUEST_NUMBER","CF_PULL_REQUEST_ID"]}},{name:"Codemagic",constant:"CODEMAGIC",env:"CM_BUILD_ID",pr:"CM_PULL_REQUEST"},{name:"Codeship",constant:"CODESHIP",env:{CI_NAME:"codeship"}},{name:"Drone",constant:"DRONE",env:"DRONE",pr:{DRONE_BUILD_EVENT:"pull_request"}},{name:"dsari",constant:"DSARI",env:"DSARI"},{name:"Earthly",constant:"EARTHLY",env:"EARTHLY_CI"},{name:"Expo Application Services",constant:"EAS",env:"EAS_BUILD"},{name:"Gerrit",constant:"GERRIT",env:"GERRIT_PROJECT"},{name:"Gitea Actions",constant:"GITEA_ACTIONS",env:"GITEA_ACTIONS"},{name:"GitHub Actions",constant:"GITHUB_ACTIONS",env:"GITHUB_ACTIONS",pr:{GITHUB_EVENT_NAME:"pull_request"}},{name:"GitLab CI",constant:"GITLAB",env:"GITLAB_CI",pr:"CI_MERGE_REQUEST_ID"},{name:"GoCD",constant:"GOCD",env:"GO_PIPELINE_LABEL"},{name:"Google Cloud Build",constant:"GOOGLE_CLOUD_BUILD",env:"BUILDER_OUTPUT"},{name:"Harness CI",constant:"HARNESS",env:"HARNESS_BUILD_ID"},{name:"Heroku",constant:"HEROKU",env:{env:"NODE",includes:"/app/.heroku/node/bin/node"}},{name:"Hudson",constant:"HUDSON",env:"HUDSON_URL"},{name:"Jenkins",constant:"JENKINS",env:["JENKINS_URL","BUILD_ID"],pr:{any:["ghprbPullId","CHANGE_ID"]}},{name:"LayerCI",constant:"LAYERCI",env:"LAYERCI",pr:"LAYERCI_PULL_REQUEST"},{name:"Magnum CI",constant:"MAGNUM",env:"MAGNUM"},{name:"Netlify CI",constant:"NETLIFY",env:"NETLIFY",pr:{env:"PULL_REQUEST",ne:"false"}},{name:"Nevercode",constant:"NEVERCODE",env:"NEVERCODE",pr:{env:"NEVERCODE_PULL_REQUEST",ne:"false"}},{name:"Prow",constant:"PROW",env:"PROW_JOB_ID"},{name:"ReleaseHub",constant:"RELEASEHUB",env:"RELEASE_BUILD_ID"},{name:"Render",constant:"RENDER",env:"RENDER",pr:{IS_PULL_REQUEST:"true"}},{name:"Sail CI",constant:"SAIL",env:"SAILCI",pr:"SAIL_PULL_REQUEST_NUMBER"},{name:"Screwdriver",constant:"SCREWDRIVER",env:"SCREWDRIVER",pr:{env:"SD_PULL_REQUEST",ne:"false"}},{name:"Semaphore",constant:"SEMAPHORE",env:"SEMAPHORE",pr:"PULL_REQUEST_NUMBER"},{name:"Sourcehut",constant:"SOURCEHUT",env:{CI_NAME:"sourcehut"}},{name:"Strider CD",constant:"STRIDER",env:"STRIDER"},{name:"TaskCluster",constant:"TASKCLUSTER",env:["TASK_ID","RUN_ID"]},{name:"TeamCity",constant:"TEAMCITY",env:"TEAMCITY_VERSION"},{name:"Travis CI",constant:"TRAVIS",env:"TRAVIS",pr:{env:"TRAVIS_PULL_REQUEST",ne:"false"}},{name:"Vela",constant:"VELA",env:"VELA",pr:{VELA_PULL_REQUEST:"1"}},{name:"Vercel",constant:"VERCEL",env:{any:["NOW_BUILDER","VERCEL"]},pr:"VERCEL_GIT_PULL_REQUEST_ID"},{name:"Visual Studio App Center",constant:"APPCENTER",env:"APPCENTER_BUILD_ID"},{name:"Woodpecker",constant:"WOODPECKER",env:{CI:"woodpecker"},pr:{CI_BUILD_EVENT:"pull_request"}},{name:"Xcode Cloud",constant:"XCODE_CLOUD",env:"CI_XCODE_PROJECT",pr:"CI_PULL_REQUEST_NUMBER"},{name:"Xcode Server",constant:"XCODE_SERVER",env:"XCS"}]});var F=B(L=>{"use strict";var $=W(),p=process.env;Object.defineProperty(L,"_vendors",{value:$.map(function(e){return e.constant})});L.name=null;L.isPR=null;L.id=null;$.forEach(function(e){let r=(Array.isArray(e.env)?e.env:[e.env]).every(function(i){return G(i)});L[e.constant]=r,r&&(L.name=e.name,L.isPR=j(e),L.id=e.constant)});L.isCI=!!(p.CI!=="false"&&(p.BUILD_ID||p.BUILD_NUMBER||p.CI||p.CI_APP_ID||p.CI_BUILD_ID||p.CI_BUILD_NUMBER||p.CI_NAME||p.CONTINUOUS_INTEGRATION||p.RUN_ID||L.name));function G(e){return typeof e=="string"?!!p[e]:"env"in e?p[e.env]&&p[e.env].includes(e.includes):"any"in e?e.any.some(function(n){return!!p[n]}):Object.keys(e).every(function(n){return p[n]===e[n]})}function j(e){switch(typeof e.pr){case"string":return!!p[e.pr];case"object":return"env"in e.pr?"any"in e.pr?e.pr.any.some(function(n){return p[e.pr.env]===n}):e.pr.env in p&&p[e.pr.env]!==e.pr.ne:"any"in e.pr?e.pr.any.some(function(n){return!!p[n]}):G(e.pr);default:return null}}});var re={};x(re,{default:()=>te});var s=h("@yarnpkg/core"),P=h("@yarnpkg/fslib"),H=X(F()),D={error:0,warn:1,info:2,debug:3};async function ee(e,n,r,{report:i,immutable:d,cache:U,persistProject:C},{loggingLevelNumber:I}){try{let g=new Set,k=n.manifest;for(let u of["dependencies","devDependencies","peerDependencies"]){let a=k.getForScope(u);I>=D.debug&&i.reportInfo(s.MessageName.UNNAMED,`Found ${a.size} ${u}`);for(let t of a.values()){let _=r.workspaces.find(m=>m.manifest.raw.name===t.name||m.manifest.raw.name===`@${t.scope}/${t.name}`);if(_){let m=s.structUtils.makeDescriptor(s.structUtils.makeIdent(t.scope||"",t.name),t.range);g.add(m),I>=D.debug&&i.reportInfo(s.MessageName.UNNAMED,`Added workspace dependency: ${s.structUtils.stringifyDescriptor(m)}`);for(let f of["dependencies","devDependencies","peerDependencies"]){let E=_.manifest.getForScope(f);for(let l of E.values()){let o=s.structUtils.makeDescriptor(s.structUtils.makeIdent(l.scope||"npm",l.name),l.range);g.add(o),I>=D.debug&&i.reportInfo(s.MessageName.UNNAMED,`Added transitive dependency from workspace: ${s.structUtils.stringifyDescriptor(o)}`)}}}else{let m=t.scope?`@${t.scope}/${t.name}`:t.name,f=s.structUtils.parseIdent(m),l=t.range.match(/^([a-z]+):/)?.[1]?t.range:`npm:${t.range}`,o=s.structUtils.makeDescriptor(f,l);g.add(o),I>=D.debug&&i.reportInfo(s.MessageName.UNNAMED,`Added dependency: ${s.structUtils.stringifyDescriptor(o)}`)}}}let A=new Map,c=new Set,R=new Map,N=u=>{let a=s.structUtils.parseDescriptor(u);return a.range.startsWith("workspace:")?s.structUtils.stringifyDescriptor(a):s.structUtils.stringifyDescriptor(s.structUtils.makeDescriptor(a,`npm:${a.range.replace(/^npm:/,"")}`))},T=u=>{let a=s.structUtils.stringifyDescriptor(u),t=N(a);if(c.has(t))return;let _=r.storedResolutions.get(u.descriptorHash);if(!_){I>=D.debug&&i.reportInfo(s.MessageName.UNNAMED,`No resolution found for ${a}`);return}R.has(_)||R.set(_,new Set),R.get(_).add(u);let m=r.storedPackages.get(_);if(!m){I>=D.debug&&i.reportInfo(s.MessageName.UNNAMED,`No package found for ${a}`);return}c.add(t);for(let[f,E]of m.dependencies)T(E);for(let[f,E]of m.peerDependencies)T(E)};for(let u of g)T(u);for(let[u,a]of R){let t=r.storedPackages.get(u);if(!t)continue;let _=Array.from(a).map(l=>s.structUtils.stringifyDescriptor(l)).filter(l=>!l.includes("virtual:")).sort();if(_.length===0)continue;let m=_.join(", "),f=new Map,E=new Map;for(let[l,o]of t.dependencies){let S=o.range.startsWith("virtual:")?`npm:${o.range.replace(/^virtual:[^#]+#npm:/,"")}`:o.range.startsWith("workspace:")||o.range.startsWith("npm:")?o.range:`npm:${o.range}`;f.set(s.structUtils.stringifyIdent(o),S)}for(let[l,o]of t.peerDependencies){let S=s.structUtils.stringifyIdent(o),O=o.range.startsWith("virtual:")?`npm:${o.range.replace(/^virtual:[^#]+#npm:/,"")}`:o.range.startsWith("workspace:")||o.range.startsWith("npm:")?o.range:`npm:${o.range}`;if(S.startsWith("@types/")&&t.peerDependenciesMeta.get(S)?.optional&&o.range==="*"){I>=D.debug&&i.reportInfo(s.MessageName.UNNAMED,`Skipping optional @types peer dependency: ${S}@${O}`);continue}E.set(S,O)}A.set(m,{version:t.linkType===s.LinkType.SOFT&&t.reference.startsWith("workspace:")?"0.0.0-use.local":t.version,resolution:s.structUtils.stringifyLocator(t),dependencies:f,peerDependencies:E,bin:t.bin,checksum:r.storedChecksums.get(u)||"",languageName:t.languageName,linkType:t.linkType})}I>=D.debug&&i.reportInfo(s.MessageName.UNNAMED,`Generated ${A.size} entries for workspace lockfile`);let V=Array.from(A.entries()).sort().map(([u,a])=>{let t=a.dependencies.size>0?`  dependencies:
${Array.from(a.dependencies.entries()).sort().map(([f,E])=>{let l=E.startsWith("workspace:")?E:`npm:${E.replace(/^npm:/,"")}`;return`    ${f.startsWith("@")?`"${f}"`:f}: "${l}"`}).join(`
`)}`:"",_=a.peerDependencies.size>0?`  peerDependencies:
${Array.from(a.peerDependencies.entries()).sort().map(([f,E])=>{let l=E.startsWith("workspace:")?E:`${E.replace(/^npm:/,"")}`,o=l.match(/[:\{\}\[\]\,&*#?<>=!%@\\]/)?`"${l}"`:l;return`    ${f.startsWith("@")?`"${f}"`:f}: ${o}`}).join(`
`)}`:"";return[`"${u}":`,`  version: ${a.version||"unknown"}`,`  resolution: "${a.resolution}"`,t,_,a.bin.size>0?`  bin:
${Array.from(a.bin.entries()).map(([f,E])=>`    ${f}: ${E}`).join(`
`)}`:"",`  checksum: ${a.checksum}`,`  languageName: ${a.languageName.toLowerCase()}`,`  linkType: ${a.linkType.toLowerCase()}`].filter(Boolean).join(`
`)+`
`}).join(`
`),b=U.cacheKey,w=`# This file is generated by running "yarn install" inside your project through the workspace-lockfile plugin.
# Manual changes might be lost - proceed with caution!

__metadata:
  version: ${r.lockfileLastVersion??"6"}
  cacheKey: ${b}

${V}`,y=P.ppath.join(n.cwd,"yarn.workspace.lock");if(process.env.WORKSPACE_LOCKFILE_FORCE_WRITE!=="true"&&d){if(await P.xfs.readFilePromise(y,"utf-8")===w)return;i.reportError(s.MessageName.UNNAMED,`The lockfile ${y} would have been modified by this install, which is explicitly forbidden`)}else await P.xfs.writeFilePromise(y,w),I>=D.info&&i.reportInfo(s.MessageName.UNNAMED,`Created ${y}`)}catch(g){let k=g instanceof Error?g.message:String(g);i.reportError(s.MessageName.UNNAMED,`Failed to generate lockfile for ${e}: ${k}`)}}function ne(e,n){if(n.persistProject!==!1)return{isWorkspaceFocused:!1};let r=process.argv.slice(2),i=r[0]==="workspaces"&&r[1]==="focus",d=i&&r.some(c=>c==="--production"),U=i&&r.some(c=>c==="--all"||c==="-A");if(!i)return{isWorkspaceFocused:!1};if(U)return{isWorkspaceFocused:!0,isProduction:d,workspaces:e.workspaces};let C=r.slice(2).filter(c=>!c.startsWith("-"));if(C.length===0){let c=P.ppath.cwd(),R=e.workspacesByCwd.get(c);if(!R)throw new Error(`No workspace found in ${c}, please specify a workspace or use --all or -A`);C.push(R.manifest.raw.name)}let I=new Map(e.workspaces.map(c=>[c.manifest.raw.name,c])),g=new Set(C),k=new Set;function A(c){if(!k.has(c)){k.add(c),g.add(c.manifest.raw.name);for(let[R,N]of new Map([...c.manifest.getForScope("dependencies").entries(),...c.manifest.getForScope("devDependencies").entries()]))if(N.range.startsWith("workspace:")){let T=I.get(N.name);T&&A(T)}}}for(let c of g){let R=I.get(c);if(R)A(R);else throw new Error(`Workspace ${c} not found in the project`)}return{isWorkspaceFocused:i,isProduction:d,workspaces:Array.from(k)}}var se={configuration:{workspaceLockfileLoggingLevel:{description:"The logging level for workspace lockfile generation",type:s.SettingsType.STRING,default:"error"}},hooks:{async afterAllInstalled(e,n){if(n.persistProject===!1)return;let r=e.configuration.get("workspaceLockfileLoggingLevel"),i=D[r]??D.error,d=ne(e,n);d.isWorkspaceFocused&&(d.isProduction||!d.workspaces?.length)||(d.isWorkspaceFocused&&H.isCI&&(n.immutable=!0),await n.report.startTimerPromise("Workspace lockfiles step",async()=>{for(let U of d.workspaces??e.workspaces){let C=U.manifest.raw.name||U.cwd,I=async()=>{await ee(C,U,e,n,{loggingLevelNumber:i})};i>=D.info?await n.report.startTimerPromise(`Generating lockfile for ${C}`,I):await I()}}))}}},te=se;return J(re);})();
return plugin;
}
};
